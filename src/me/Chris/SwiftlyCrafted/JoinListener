package me.Chris.SwiftlyCrafted;

import java.io.File;
import java.io.IOException;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;

import Commands.RankSubCommands;
import me.Chris.SwiftlyCrafted.Hub.main;

public class JoinListener implements Listener {
	private final main plugin;
	 
	public JoinListener(main plugin) {
        this.plugin = plugin;
	}
	//File playerFile;
	
	//public static FileConfiguration playerFile;
	
	@EventHandler
	public void onJoin(PlayerJoinEvent event){
		event.getPlayer().getInventory().clear();
		event.setJoinMessage("");
		RankSubCommands rsc = new RankSubCommands(plugin);
		final Player p = event.getPlayer();
		
		File playersDir = new File(this.plugin.getDataFolder() + File.separator + "players");
		if(!playersDir.exists()){
		    playersDir.mkdir();
		}
		 
		File playerFile = new File(this.plugin.getDataFolder() + File.separator + "players" + File.separator + p.getName() + ".yml");
		if(!playerFile.exists()){
		     try {
				playerFile.createNewFile();
			} catch (IOException e) {
				// TODO Autogenerated catch block
				e.printStackTrace();
			} // needs try catch block
		}
		FileConfiguration fc = YamlConfiguration.loadConfiguration(playerFile);
		
		

	    ItemStack mainmenu = new ItemStack(Material.CHEST);
	    ItemMeta im = mainmenu.getItemMeta();
	    im.setDisplayName(ChatColor.GREEN + "" + ChatColor.BOLD + "Main Menu");
		mainmenu.setItemMeta(im);
		p.getInventory().setItem(4, mainmenu);
		p.sendMessage(ChatColor.AQUA + "Welcome to SwiftlyCrafted " + ChatColor.YELLOW + p.getName() + ChatColor.AQUA + "!");	
		if(p.hasPlayedBefore()) {
			if(fc.getString("rank").equalsIgnoreCase("reg")){
				fc.set("rank", "reg");
				try {
					fc.save(playerFile);
				} catch (IOException e) {
					e.printStackTrace();
				}
				rsc.executeregCommand(p.getName());
			}else if(fc.getString("rank").equals("mod")){
				fc.set("rank", "mod");
				try {
					fc.save(playerFile);
				} catch (IOException e) {
					e.printStackTrace();
				}
				rsc.executeModCommand(p.getName());
			}else if(fc.getString("rank").equals("admin")){
				fc.set("rank", "admin");
					try {
						fc.save(playerFile);
					} catch (IOException e) {
						e.printStackTrace();
					}
			    rsc.executeAdminModCommand(p.getName());
			}else if(fc.getString("rank").equals("dev")){
				fc.set("rank", "dev");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeDevCommand(p.getName());
			}
			else if(fc.getString("rank").equals("master")) {
				fc.set("rank", "master");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeMasterCommand(p.getName());
			}
			else if(fc.getString("rank").equals("elite")) {
				fc.set("rank", "elite");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeEliteMasterCommand(p.getName());
			}
			else if(fc.getString("rank").equals("eldermod")) {
				fc.set("rank", "eldermod");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeElderModCommand(p.getName());
			}
			else if(fc.getString("rank").equals("owner")) {
				fc.set("rank", "dev");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeOPCommand(p.getName());
			}
			else if(fc.getString("rank").equals("yt")) {
				fc.set("rank", "dev");
				try {
					fc.save(playerFile);
				}
				catch (IOException e) {
					e.printStackTrace();
				}
			    rsc.executeYTCommand(p.getName());
			}
		}else{
			p.setAllowFlight(false);
			p.setDisplayName(ChatColor.GRAY + p.getName() + ChatColor.WHITE);
			p.setGameMode(GameMode.SURVIVAL);
			p.setExp(0);
			p.setLevel(1);
			p.setFoodLevel(20);
			fc.set("rank", "newbie");
			try {
				fc.save(playerFile);
			} catch (IOException e) {
				e.printStackTrace();
			}
			Bukkit.getServer().getScheduler().scheduleSyncRepeatingTask(this.plugin, new Runnable(){
		        @SuppressWarnings("deprecation")
				@Override
		        public void run() {
		        	p.setFoodLevel(20);
		    		p.setHealth(20);
		                if(p.getLocation().getBlockY() < 0){
		                	p.teleport(p.getWorld().getSpawnLocation());
		                }
		        }
			}, 0, 1);
			rsc.executeregCommand(event.getPlayer().getName());
		}
		for(Player all : Bukkit.getOnlinePlayers()) {
			if(p.isOp()) {
				all.sendMessage(ChatColor.BLUE + ">> " + p.getDisplayName() + ChatColor.RED + "" + ChatColor.ITALIC + " has joined the lobby!");
			}
			if(fc.getString("rank").equals("mod")) {
				all.sendMessage(ChatColor.BLUE + ">> " + p.getDisplayName() + ChatColor.RED + "" + ChatColor.ITALIC + " has joined the lobby!");
			}
		}
	}
}
